<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>OAuth refresh stategies | Dwolla API</title><meta name=description content="Best practices for managing your access tokens."><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.ed3c.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto+Slab:300|Open+Sans:300,400,600,700"><script src=/js/head-scripts.32fa.js></script></head><body><!--[if lt IE 8]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]--><header><div class=header__primary><div class=page-wrap><div><a href="/" class="logo icon-logo-dwolla-white">Dwolla</a><div class=hamburger><a href=http://dwolla.com/register>Sign Up</a> <a class="btn primary js-hamburger">Menu</a></div></div><nav class=js-hamburger-nav><a href=https://www.dwolla.com/about>Product</a> <a href="/">API</a> <a href="https://www.dwolla.com/contact?b=nav">Contact sales</a> <a href=http://dwolla.com/login>Log in</a> <a class="btn primary" href=http://dwolla.com/register>Sign Up</a></nav></div></div><nav class="header__secondary js-two-col-nav-toggle"><div class=page-wrap><a href="/guides/">Guides</a> <a href="/resources/" class=active>Resources</a> <a href="https://docsv2.dwolla.com/">API docs</a> <a href=/pages/sdks.html class="no-nav js-two-col-no-toggle">SDKs</a><div class="custom-select custom-select--blue"><select name=select class=language_select><option value=raw>raw</option><option value=php>php</option><option value=ruby>ruby</option><option value=python>python</option><option value=javascript>javascript</option></select><div class=arrow></div></div></div></nav></header><div class=content><div class=cnt-two-col><div class=page-wrap><section class="cnt-two-col__nav js-two-col-nav"><div class=close><button class="js-two-col-nav-close icon-cnt-two-col-close"></button></div><div class=language-picker><h6>Language</h6><div class="custom-select custom-select--blue"><select class=language_select name=select><option value=raw>raw</option><option value=php selected>php</option><option value=ruby>ruby</option><option value=python>python</option><option value=javascript>javascript</option></select><div class=arrow></div></div></div><!-- nav elements below should be in the same order of the secondary navigation --><nav class=side-nav><section id=js-sidenav-dropdown class=side-nav__dropdown><h6>Choose a guide</h6><div class=picker id=js-sidenav-dropdown-button><button>Please select a guide</button><div class="icon icon-side-nav-collapse-plus"></div><div class="icon icon-side-nav-collapse-minus"></div></div><nav id=js-sidenav-dropdown-nav><a href="/guides/sandbox-setup/">Set up Sandbox</a> <a href="/guides/send-money/">Send money to your users</a> <a href="/guides/receive-money/">Receive money from your users</a> <a href="/guides/transfer-money-between-users/">Transfer money between users</a> <a href="/guides/webhooks/">Webhooks</a></nav></section><section class=steps-nav style=display:none><h6>Follow the steps</h6><ol><li><a href=/guides/send-money>Overview: Send money to your users</a><div class=dot></div><ol><li><a href=/guides/send-money/01-white-label-onboarding.html>Option 1: White label</a><div class=dot></div></li><li><a href=/guides/send-money/01-direct-onboarding.html>Option 2: Dwolla Direct</a><div class=dot></div></li></ol></li><li><a href=/guides/send-money/02-fetch-funding-sources.html>Fetch funding sources</a><div class=dot></div></li><li><a href=/guides/send-money/03-create-transfer.html>Create a transfer</a><div class=dot></div></li><li><a href=/guides/send-money/04-check-transfer.html>Check transfer status</a><div class=dot></div></li></ol></section><!-- <section class="side-nav__options" style="display:none">
    <h6>Options</h6>
    <ul>
        <li class="external-link"><a href="https://developers.dwolla.com/dev/pages/guides/masspay" target="_blank"><span class="icon-sidenav-option">MassPay V1</span></a></li>
        <li class="external-link"><a href=""><span class="icon-sidenav-option">Recurring and Scheduled V1</span></a></li>
    </ul>
</section> --><section class=steps-nav style=display:none><h6>Follow the steps</h6><ol><li><a href=/guides/receive-money>Overview</a><div class=dot></div><ol><li><a href=/guides/receive-money/01-white-label-onboarding.html>Option 1: White label</a><div class=dot></div></li><li><a href=/guides/receive-money/01-direct-onboarding.html>Option 2: Dwolla Direct</a><div class=dot></div></li></ol></li><li><a href=/guides/receive-money/02-check-transfer.html>Check transfer status</a><div class=dot></div></li></ol></section><section class=steps-nav style=display:none><h6>Follow the steps</h6><ol><li><a href=/guides/sandbox-setup>Overview: Sandbox setup</a><div class=dot></div></li><li><a href=/guides/sandbox-setup/01-create-master-account.html>Create a master Sandbox account</a><div class=dot></div></li><li><a href=/guides/sandbox-setup/02-create-child-account.html>Create a child Sandbox account</a><div class=dot></div></li><li><a href=/guides/sandbox-setup/03-create-application.html>Create an application</a><div class=dot></div></li><li><a href=/guides/sandbox-setup/04-enable-sdk-sandbox-mode.html>Enable Sandbox mode</a><div class=dot></div></li></ol></section><section class=steps-nav style=display:none><h6>Follow the steps</h6><ol><li><a href=/guides/webhooks>Overview: Webhooks</a><div class=dot></div></li><li><a href=/guides/webhooks/01-obtain-authorization.html>Obtain authorization</a><div class=dot></div></li><li><a href=/guides/webhooks/02-create-subscription.html>Create a webhook subscription</a><div class=dot></div></li><li><a href=/guides/webhooks/03-validating-webhooks.html>Validating webhooks</a><div class=dot></div></li><li><a href=/guides/webhooks/04-process-webhooks.html>Processing webhooks</a><div class=dot></div></li></ol></section><section class=steps-nav style=display:none><h6>Follow the steps</h6><ol><li><a href=/guides/transfer-money-between-users>Overview: transfer money between your users</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/01-access-token.html>Generate an access token</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/02-create-verified-customer.html>Create a verified customer</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/03-attach-unverified-bank.html>Attach an unverified funding source</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/04-create-unverified-customer.html>Create an unverified Customer</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/05-attach-verified-bank.html>Attach a verified funding source</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/06-create-transfer.html>Create a transfer</a><div class=dot></div></li><li><a href=/guides/transfer-money-between-users/07-check-transfer.html>Check the status of your transfer</a><div class=dot></div></li></ol></section></nav><nav class="side-nav active"><section><h6>Tools</h6><ul><li><a href=/resources/sandbox.html>Sandbox</a></li><li class=external-link><a href=http://dwolla-token.herokuapp.com target=_blank><span class=icon-sidenav-option>Token generator</span></a></li><li><a href=/resources/changelog.html>Change log</a></li><li class=external-link><a href="http://status.dwolla.com/" target=_blank><span class=icon-sidenav-option>Status</span></a></li></ul><h6>Articles</h6><ul><li><a href=/resources/account-types.html>Account types</a></li><li><a href=/resources/customer-verification.html>Customer verification</a></li><li><a href=/resources/oauth-refresh-strategies.html class=active>OAuth refresh stategies</a></li><li><a href=/resources/transfer-workflow.html>Transfer workflow</a></li></ul></section></nav></section><section class=cnt-two-col__content><h1>OAuth refresh strategies</h1><p>Dwolla’s implementation of the <a href=https://tools.ietf.org/html/rfc6749 target=_blank>OAuth 2.0</a> standard uses short-lived access tokens and long-lived refresh tokens. When a user account grants authorization to your application, Dwolla will issue an access token which expires in 1 hour and a refresh token which expires in 60 days. You’ll likely want to access a user account for longer than 1 hour, which means you’ll want to implement a way to refresh authorization.</p><p><strong>Note</strong>: A user account can represent your own account or an account that belongs to a user of your application. Follow these strategies even if you’re only using OAuth in order to access your own account via the API.</p><p><strong>Important</strong>: We recommend securely storing access/refresh tokens in a database with the associated user account.</p><p>There are two recommended strategies for managing short-lived access tokens. If your application relies heavily on calling the Dwolla API several times in a day, we recommend setting up a cron job to refresh authorization constantly during the day. However, if for example, your application only calls Dwolla’s API once a day or once a month, we recommend refreshing your token pair prior to making any API call.</p><h3>Strategy 1: Preemptively refresh authorization</h3><p>You set up a cron job that runs in the background every hour to refresh each user account’s OAuth access token. Refreshing authorization would happen behind the scenes as a backend process. You would first query your database for tokens that are about to expire, make a POST request to refresh authorization, and update your database to include the newly refreshed token pair. Note: Be prepared to handle errors gracefully while the cron job is running.</p><h5>Node.JS Example</h5><div class="code-snippet js-code-snippet language-javascriptnohide"><button class="btn alternative">copy</button><div class="code-snippet__cnt highlight"><pre><code class=language-javascriptnohide data-lang=javascriptnohide><span class=kd>var</span> <span class=nx>cron</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>'cron'</span><span class=p>);</span>
<span class=kd>var</span> <span class=nx>cronJob</span> <span class=o>=</span> <span class=nx>cron</span><span class=p>.</span><span class=nx>job</span><span class=p>(</span><span class=s2>"0 */55 * * * *"</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>User</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span>
        <span class=na>where</span><span class=p>:</span> <span class=p>{</span>
            <span class=na>dwolla_id</span><span class=p>:</span> <span class=s1>'812-196-0757'</span> <span class=c1>//query user in database</span>
        <span class=p>}</span>
    <span class=p>}).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//If user exists in database</span>
            <span class=kd>var</span> <span class=nx>refreshToken</span> <span class=o>=</span> <span class=nx>user</span><span class=p>.</span><span class=nx>dwolla_refresh</span><span class=p>;</span> <span class=c1>//grab the existing stored refresh token</span>
            <span class=nx>Dwolla</span><span class=p>.</span><span class=nx>refreshAuth</span><span class=p>(</span><span class=nx>refreshToken</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>auth</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//pass refresh token into refreshAuth request</span>
                <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>return</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=nx>user</span><span class=p>.</span><span class=nx>updateAttributes</span><span class=p>({</span>
                    <span class=na>dwolla_refresh</span><span class=p>:</span> <span class=nx>auth</span><span class=p>.</span><span class=nx>refresh_token</span> <span class=c1>//From response, set new refresh token in database</span>
                <span class=p>}).</span><span class=nx>success</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>"updated"</span><span class=p>);</span>
                <span class=p>})</span>
            <span class=p>});</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>"user does not exist"</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}).</span>
    <span class=k>catch</span> <span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
    <span class=p>})</span>
    <span class=nx>console</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>'cron job completed'</span><span class=p>);</span>
<span class=p>});</span>
<span class=nx>cronJob</span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
</code></pre></div></div><h3>Strategy 2: Refresh on demand or handle failure</h3><p>On demand: Before making any API call to Dwolla, query your database to get the stored refresh token, refresh authorization, update the new token pair in your database, and lastly make the call to Dwolla. This method prevents excessive calls to Dwolla and only requires you to refresh authorization when needed. Handle failure: Make API call with access token; if access token is invalid, try to update it using the stored refresh token; if refresh request is successful, update the existing token pair in your database and re-attempt the initial API request. Optional: cache the access token for reuse on subsequent requests.</p><h3>Best practices</h3><p>You should be able to deal with scenarios where a token is invalid even if you assume it is valid—e.g., if a user account revokes access to your application on dwolla.com. Check that the error is “Invalid access token” and that you are correctly passing in your token when calling Dwolla before requesting a new access/refresh token from Dwolla.</p><ul><li>Consider possible race conditions where multiple threads attempt to use the same refresh token at the same time. In this case, one thread will succeed and cause the other thread’s request to fail.</li><li>Make sure you know the difference between a generic error and “Expired access token”. Be prepared to catch an expired access token error and refresh if needed.</li><li>Handle timeouts and non-successful requests to Dwolla.</li><li>If refreshing authorization for many accounts at the same time, it’s important that you make each request sequentially instead of all at once. For instance, if you attempt 10,000 refresh token requests at the same time, you’ll get responses, but many will result in timeouts, which mean you won’t know what the new access token and refresh token are.</li></ul></section></div></div></div><section class=big-disclaimer><div class=page-wrap><h5>Financial institutions play an important role in the Dwolla network.</h5><p>Dwolla, Inc. is an agent of Veridian Credit Union and Compass Bank and all funds associated with your account in the Dwolla network are held in pooled accounts at Veridian Credit Union and Compass Bank. These funds are not eligible for individual insurance, including FDIC insurance and may not be eligible for share insurance by the National Credit Union Share Insurance Fund. Dwolla, Inc. is the operator of a software platform that communicates user instructions for funds transfers to Veridian Credit Union and Compass Bank.</p></div></section><footer><div class=page-wrap><nav><a href="https://www.dwolla.com/pricing?b=footer">Pricing</a> <a href="https://www.dwolla.com/contact?b=footer">Contact sales</a> <a href="http://help.dwolla.com/">Support</a> <a href=https://www.dwolla.com/security>Security</a> <a href="http://blog.dwolla.com/">Blog</a> <a href="http://press.dwolla.com/">Press</a> <a href=https://www.dwolla.com/careers>Careers</a></nav><nav class=disclaimer><span>© 2015 Dwolla, Inc</span> <a href="https://legal.dwolla.com/privacy/">Privacy</a> <a href="https://legal.dwolla.com/tos/">Legal</a> <a href="https://legal.dwolla.com/about-our-financial-institution-partner/">Dwolla, Inc. is an agent of its Financial Institution Partner(s)</a></nav></div></footer><script src=//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script>window.jQuery || document.write('<script src="/_bower_components/jquery/jquery.min.js"><\/script>')</script><script src=/js/script.c13b.js></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
  e=o.createElement(i);r=o.getElementsByTagName(i)[0];
  e.src='//www.google-analytics.com/analytics.js';
  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
  ga('create','UA-30404064-1');ga('send','pageview');</script></body></html>