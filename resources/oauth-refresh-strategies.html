<!DOCTYPE html><html class=no-js><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>OAuth Refresh Stategies | Dwolla Developers</title><meta name=description content="Best practices for managing your access tokens."><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/main.c3ea.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Roboto+Slab:300|Open+Sans:300,400,600,700"><script src=/js/head-scripts.32fa.js></script></head><body><!--[if lt IE 8]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]--><header><div class="header__primary page-wrap"><div><a href="/" class="logo icon-logo-dwolla-white">Dwolla</a><div class=hamburger><a href=http://dwolla.com/register>Sign Up</a> <a class="btn primary js-hamburger">Menu</a></div></div><nav class=js-hamburger-nav><a href=https://www.dwolla.com/about>Product</a> <a href="">Developer</a> <a href="https://www.dwolla.com/contact?b=nav">Contact sales</a> <a href=http://dwolla.com/login>Log in</a> <a class="btn primary" href=http://dwolla.com/register>Sign Up</a></nav></div><nav class="header__secondary js-two-col-nav-toggle"><div class=page-wrap><a href="/guides/">Guides</a> <a href="/resources/" class=active>Resources</a> <a href=/pages/api-docs.html>API Docs</a> <a href=/pages/sdks.html class="no-nav js-two-col-no-toggle">SDKs</a><div class="custom-select custom-select--blue"><select name=select id=language_select><option value=raw>raw</option><option value=php>php</option><option value=ruby>ruby</option><option value=python>python</option><option value=javascript>javascript</option></select><div class=arrow></div></div></div></nav></header><div class=content><div class=cnt-two-col><div class=page-wrap><section class="cnt-two-col__nav js-two-col-nav"><nav class="side-nav active"><section><h6>Tools</h6><ul><li><a href=/resources/sandbox.html>Sandbox</a></li><li><a href="">Token generator</a></li><li><a href=/resources/changelog.html>Change log</a></li><li><a href="http://status.dwolla.com/" target=_blank class=icon-sidenav-option>Status</a></li></ul><h6>Articles</h6><ul><li><a href=/resources/ach-clearing-times.html>ACH Clearing Times</a></li><li><a href=/resources/customer-verification.html>Customer Verification</a></li><li><a href=/resources/oauth-refresh-strategies.html class=active>OAuth Refresh Stategies</a></li></ul></section></nav></section><section class=cnt-two-col__content><h1>OAuth Refresh Strategies</h1><p>Dwolla’s implementation of the <a href=https://tools.ietf.org/html/rfc6749>OAuth 2.0</a> standard uses short-lived access tokens and long-lived refresh tokens. When a user account grants authorization to your application, Dwolla will issue an access token which expires in 1 hour and a refresh token which expires in 60 days. You’ll likely want to access a user account for longer than 1 hour, which means you’ll want to implement a way to refresh authorization.</p><p><strong>Note</strong>: A user account can represent your own account or an account that belongs to a user of your application. Follow these strategies even if you’re only using OAuth in order to access your own account via the API.</p><p><strong>Important</strong>: We recommend securely storing access/refresh tokens in a database with the associated user account.</p><p>There are two recommended strategies for managing short-lived access tokens. If your application relies heavily on calling the Dwolla API several times in a day, we recommend setting up a cron job to refresh authorization constantly during the day. However, if for example, your application only calls Dwolla’s API once a day or once a month, we recommend refreshing your token pair prior to making any API call.</p><h3>Strategy 1: Preemptively refresh authorization</h3><p>You set up a cron job that runs in the background every hour to refresh each user account’s OAuth access token. Refreshing authorization would happen behind the scenes as a backend process. You would first query your database for tokens that are about to expire, make a POST request to refresh authorization, and update your database to include the newly refreshed token pair. Note: Be prepared to handle errors gracefully while the cron job is running.</p><div class="code-snippet js-code-snippet language-"><button class="btn alternative">copy</button><div class=code-snippet__selector><nav><button class=selector_switch id=raw>raw</button> <button class=selector_switch id=php>php</button> <button class=selector_switch id=ruby>ruby</button> <button class=selector_switch id=python>python</button> <button class=selector_switch id=javascript>javascript</button></nav></div><div class="code-snippet__cnt highlight"><pre><code class=language- data-lang="">var cron = require('cron');
var cronJob = cron.job("0 */55 * * * *", function() {
    User.find({
        where: {
            dwolla_id: '812-196-0757' //query user in database
        }
    }).then(function(user) {
        if (user) { //If user exists in database
            var refreshToken = user.dwolla_refresh; //grab the existing stored refresh token
            Dwolla.refreshAuth(refreshToken, function(error, auth) { //pass refresh token into refreshAuth request
                if (error) {
                    return console.log(error);
                }
                user.updateAttributes({
                    dwolla_refresh: auth.refresh_token //From response, set new refresh token in database
                }).success(function() {
                    console.log("updated");
                })
            });
        } else {
          console.log("user does not exist");
        }
    }).
    catch (function(err) {
        console.log(err);
    })
    console.info('cron job completed');
});
cronJob.start();
</code></pre></div></div><h3>Strategy 2: Refresh on demand or handle failure</h3><p>On demand: Before making any API call to Dwolla, query your database to get the stored refresh token, refresh authorization, update the new token pair in your database, and lastly make the call to Dwolla. This method prevents excessive calls to Dwolla and only requires you to refresh authorization when needed. Handle failure: Make API call with access token; if access token is invalid, try to update it using the stored refresh token; if refresh request is successful, update the existing token pair in your database and re-attempt the initial API request. Optional: cache the access token for reuse on subsequent requests.</p><h3>Best practices</h3><p>You should be able to deal with scenarios where a token is invalid even if you assume it is valid—e.g., if a user account revokes access to your application on dwolla.com. Check that the error is “Invalid access token” and that you are correctly passing in your token when calling Dwolla before requesting a new access/refresh token from Dwolla.</p><ul><li>Consider possible race conditions where multiple threads attempt to use the same refresh token at the same time. In this case, one thread will succeed and cause the other thread’s request to fail.</li><li>Make sure you know the difference between a generic error and “Expired access token”. Be prepared to catch an expired access token error and refresh if needed.</li><li>Handle timeouts and non-successful requests to Dwolla.</li><li>If refreshing authorization for many accounts at the same time, it’s important that you make each request sequentially instead of all at once. For instance, if you attempt 10,000 refresh token requests at the same time, you’ll get responses, but many will result in timeouts, which mean you won’t know what the new access token and refresh token are.</li></ul></section></div></div></div><section class=big-disclaimer><div class=page-wrap><h5>Financial institutions play an important role in the Dwolla network.</h5><p>Dwolla, Inc. is an agent of Veridian Credit Union and all funds associated with your account in the Dwolla network are held in a pooled account at Veridian Credit Union. These funds are not eligible for individual insurance, and may not be eligible for share insurance by the National Credit Union Share Insurance Fund. Dwolla, Inc. is the operator of a software platform that communicates user instructions for funds transfers to Veridian Credit Union.</p></div></section><footer><div class=page-wrap><nav><a href=https://about.dwolla.com>About</a> <a href=https://www.dwolla.com/support>Support</a> <a href=https://www.dwolla.com/security>Security</a> <a href=https://about.dwolla.com/pricing>Pricing</a> <a href="http://press.dwolla.com/">Press</a> <a href="http://blog.dwolla.com/">Blog</a> <a href=https://www.dwolla.com/careers>Careers</a> <a href=https://about.dwolla.com/contact>Contact</a></nav><nav class=disclaimer><span>© 2015 Dwolla, Inc</span> <a href="https://legal.dwolla.com/privacy/">Privacy</a> <a href="https://legal.dwolla.com/tos/">Legal</a> <a href="https://legal.dwolla.com/about-our-financial-institution-partner/">Dwolla, Inc. is an agent of its Financial Institution Partner(s)</a></nav></div></footer><script src=//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script>window.jQuery || document.write('<script src="/_bower_components/jquery/jquery.min.js"><\/script>')</script><script src=/js/script.1120.js></script><!-- Google Analytics: change UA-XXXXX-X to be your site's ID. --><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
  e=o.createElement(i);r=o.getElementsByTagName(i)[0];
  e.src='//www.google-analytics.com/analytics.js';
  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
  ga('create','UA-30404064-1');ga('send','pageview');</script></body></html>